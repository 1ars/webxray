<!DOCTYPE html>
<meta charset="utf-8">
<link rel="stylesheet" href="hierarchic-source-code.css">
<link rel="stylesheet" href="../webxray.css">
<title>Easy Remix Dialog</title>
<script src="../jquery.min.js"></script>
<script src="render-dom.js"></script>
<script src="edit-dom.js"></script>
<script src="../src/utils.js"></script>
<script src="../src/tag-colors.js"></script>
<script src="../src/event-emitter.js"></script>
<script src="../src/focused-overlay.js"></script>
<style>
body {
  font-family: Baskerville, Georgia, serif;
  background: white;
}

h1, h2 {
  font-weight: normal;
  margin-top: 0.5em;
  margin-bottom: 0.1em;
}

#dom-rendering-column {
  width: 480px;
  float: left;
}

#preview-column {
  width: 480px;
  float: left;
  margin-left: 2em;
}

.button {
  float: right;
  padding: 0.5em;
  background: #f0f0f0;
  margin: 0.25em;
  cursor: pointer;
}

div.button:hover {
  background: black;
  color: white;
}
</style>
<div id="buttons">
  <div class="button" id="nevermind">Nevermind</div>
  <div class="button" id="ok">Ok</div>
</div>
<div id="header"><h1></h1></div>
<div id="dom-rendering-column">
  <h2>Source Code</h2>
  <div id="dom-rendering"></div>
</div>
<div id="preview-column">
  <h2>Preview</h2>
  <div id="preview"></div>
</div>
<div id="sample" style="display: none;">
  <div>
    <p>Here is starting <em>HTML</em>.</p>
    <img src="../github-ribbon.png">
    <ul class="sample-list" id="sample-id">
      <li class="areallyreallyreallyreallyreallyridiculouslylongclassname">List item one</li>
    </ul>
  </div>
</div>
<script>
function enableDragAndDrop(rendering) {
  var dropZoneHTML = '<div class="drop-zone"></div>'
  
  function activateDraggable(draggable) {
    draggable.attr("draggable", "true");
    draggable.bind('dragstart', function(event) {
      var currDrag = rendering.find('.current-drag');

      if (currDrag.length)
        return;

      var linked = $(this).data("linked-node");
      var e = event.originalEvent;
      e.dataTransfer.effectAllowed = 'move';
      if (linked.nodeType == linked.TEXT_NODE)
        e.dataTransfer.setData('text/plain', linked.nodeValue);
      else
        e.dataTransfer.setData('text/html', $(linked).outerHtml());
      $(this).addClass('current-drag');
    });
    draggable.bind('dragend', function(event) {
      rendering.find('.current-drop').removeClass('current-drop');
      rendering.find('.current-drag').removeClass('current-drag');
    });
  }
  
  function activateDropZone(dropZone) {
    dropZone.bind('dragenter', function(event) {
      rendering.find('.current-drop').removeClass('current-drop');
      $(this).addClass('current-drop');
      return false;
    });
  }

  function makeDropZones() {
    rendering.find('.drop-zone').remove();
    rendering.find('ul.children > li').append(dropZoneHTML);
    rendering.find('span.start').after(dropZoneHTML);

    var dropZones = rendering.find('.drop-zone');
    activateDropZone(dropZones);
  }
  
  function initialize() {
    var draggables = rendering.find('div.element, div.text');
    activateDraggable(draggables);
    makeDropZones();
  }
  
  rendering.bind('dragover', function(event) {
    var currDrag = rendering.find('.current-drag');
    var currDrop = rendering.find('.current-drop');

    //console.log("over ", event.originalEvent.dataTransfer.types);

    // Are we being dragged into an element *inside* the
    // dragged element?
    if (currDrag.parent("li").has(currDrop.get(0)).length)
      return;

    event.preventDefault();
  });
  
  rendering.bind('drop', function(event) {
    var currDrag = rendering.find('.current-drag');
    var dropTarget = rendering.find('.current-drop');
    var nodeToMove = currDrag.data("linked-node");
    
    function moveNode() {
      if (dropTarget.prev("span.start").length) {
        var parentElement = dropTarget.parent().data("linked-node");
        if (!dropTarget.next("ul.children").length)
          dropTarget.after('<ul class="children"></ul>');
        $(parentElement).prepend(nodeToMove);
        dropTarget.next("ul.children").prepend(currDrag.parent());
      } else {
        var element = dropTarget.prev().data("linked-node");
        $(element).after(nodeToMove);
        $(dropTarget).closest("li").after(currDrag.parent());
      }
      currDrag.slideDown();
      makeDropZones();
    }
    
    if (currDrag.length) {
      currDrag.slideUp(moveNode);
    } else {
      var data = event.originalEvent.dataTransfer;
      var html = data.getData('text/html');
      var text = data.getData('text/plain');

      if (html) {
        nodeToMove = $(html).last().get(0);
        currDrag = $(nodeToMove).renderDom();
      } else if (text) {
        // TODO: This should really be part of jQuery.fn.renderDom().
        nodeToMove = document.createTextNode(text);
        currDrag = $('<div class="text"></div>').text(text);
        currDrag.data("linked-node", nodeToMove);
      } else {
        throw new Error("unsupported dataTransfer type");
      }

      activateDraggable(currDrag);
      $(document.body).append(currDrag);
      currDrag.hide();
      currDrag.wrap('<li></li>');

      moveNode();
      // TODO: call rendering.trigger('dragend');?
    }
    return false;
  });

  initialize();
}

$(window).ready(function() {
  var isInIframe = !(top === self);
  var responseSent = false;
  var isStarted = false;

  function onMessage(data) {
    if (isStarted)
      return;
    isStarted = true;
    
    var base = document.createElement('base');
    base.setAttribute('href', data.baseURI);
    $(document.head).append(base);
    $("#header h1").text(data.title);
    $("#preview").append(data.startHTML);
    var rendered = $('#preview').children().renderDom();

    var focused = jQuery.focusedOverlay();

    rendered.mouseover(function(event) {
      var target = $(event.target);

      if (!target.is('div.element'))
        target = target.closest('div.element');
      var linkedNode = target.data("linked-node");
      if (linkedNode)
        focused.set(linkedNode);
    });

    enableDragAndDrop(rendered);
    rendered.bind('dragend', function() {
      focused.unfocus();
    });
    rendered.mouseout(function(event) {
      focused.unfocus();
    });
    var editables = rendered.find(".text, .attributes .value");
    editables.makeTextEditable().click(function() {
      focused.unfocus();
    });
    $("#dom-rendering").append(rendered);
  }
  
  if (isInIframe) {
    window.addEventListener("message", function(event) {
      if (event.data && event.data.length && event.data[0] == '{') {
        onMessage(JSON.parse(event.data));
      }
    }, false);

    var sendMessage = function sendMessageViaPostMessage(data) {
      window.parent.postMessage(JSON.stringify(data), "*");
    }
  } else {
    onMessage({
      title: "Here is a title.",
      instructions: "Here are instructions.",
      startHTML: $("#sample").html(),
      baseURI: document.baseURI
    });

    sendMessage = function fakeSendMessage(data) {
      alert("Sending the following to parent window: " +
            JSON.stringify(data));
    }
  }
    
  $("#nevermind.button").click(function() {
    if (!responseSent) {
      sendMessage({msg: 'nevermind'});
      responseSent = true;
    }
  });
  $("#ok.button").click(function() {
    if (!responseSent) {
      sendMessage({msg: 'ok', endHTML: $("#preview").html()});
      responseSent = true;
    }
  });
});
</script>
